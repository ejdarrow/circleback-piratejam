<html>
<head>
<style>
  :root {
    --gold: #FFD700;
    --blood: #880808;
    --wood: #867342;
    --marble: #FFFCF0;
    --ebony: #555D50;
    --container-height: 1000px;
    --container-width: 1000px;
    --radial-difference: 95px;
    --radial-difference-half: calc(var(--radial-difference) / 2);
    --top-base: 0px;
    --left-base: 0px;
  }
  ::backdrop {
    background-color: gray;
    opacity: 0.95;
  }
  .choice-button-holder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  div {
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10 and IE 11 */
    user-select: none; /* Standard syntax */
  }
  div > img {
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10 and IE 11 */
    user-select: none; /* Standard syntax */
  }
  div > p {
    -webkit-user-select:auto; /* Safari */
    -ms-user-select: auto; /* IE 10 and IE 11 */
    user-select: auto; /* Standard syntax */
  }
  .menu-container {
    background-color:white;
    height: var(--container-height);
    width: var(--container-width);
    position: absolute;
    top: var(--top-base);
    left:var(--left-base);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .menu-presenter {
    display:block;
    justify-content:center;
    align-items:center;
  }

  .container {
    height: var(--container-height);
    width: var(--container-width);
    position: absolute;
    top: var(--top-base);
    left:var(--left-base);
  }
  .ring-inner { /* background-color: black; */
    background-color: var(--blood);
    border-radius: 50%;
    position: absolute;
    margin: var(--radial-difference-half);
    top: var(--top-base);
    left: var(--left-base);
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10 and IE 11 */
    user-select: none; /* Standard syntax */
  }

  .ring-inner > img {
    height: 140%;
    width: 140%;
    margin-left:-20%;
    margin-top:-20%;
    pointer-events:none;
  }

  .ring {
    background-color: black;
    border-radius: 50%;
    position: absolute;
    margin: var(--radial-difference-half);
    top: var(--top-base);
    left: var(--left-base);

  }
  .ring > img {
    pointer-events:none;
  }
  .ring-one {
    height: calc(var(--container-height) - var(--radial-difference));
    width: calc(var(--container-width) - var(--radial-difference));
  }
  .ring-inner-one {
    height: calc(var(--container-height) - calc( 2 * var(--radial-difference)));
    width: calc(var(--container-width) - calc( 2 * var(--radial-difference)));
  }
  .ring-two {
    height: calc(var(--container-height) - calc( 3 * var(--radial-difference)));
    width:  calc(var(--container-width) - calc( 3 * var(--radial-difference)));
  }
  .ring-inner-two {
    height:  calc(var(--container-height) - calc( 4 * var(--radial-difference)));
    width:  calc(var(--container-height) - calc( 4 * var(--radial-difference)));
  }
  .ring-three {
    height: calc(var(--container-height) - calc( 5 * var(--radial-difference)));
    width:  calc(var(--container-width) - calc( 5 * var(--radial-difference)));
  }
  .ring-inner-three {
    height:  calc(var(--container-height) - calc( 6 * var(--radial-difference)));
    width:  calc(var(--container-height) - calc( 6 * var(--radial-difference)));
  }
  .ring-four {
    height: calc(var(--container-height) - calc( 7 * var(--radial-difference)));
    width:  calc(var(--container-width) - calc( 7 * var(--radial-difference)));
  }
  .ring-inner-four {
    height:  calc(var(--container-height) - calc( 8 * var(--radial-difference)));
    width:  calc(var(--container-height) - calc( 8 * var(--radial-difference)));
  }
</style>
<script>
  // Some global quick functions. Heavy stuff is at the bottom.

  function makeBetweenTwoAndSixteen(val) {
    let wrappedVal = parseInt(Math.min(17, Math.max(val,1)));
    if(wrappedVal == 17){
      return 2;
    } else if(wrappedVal==1){
      return 16;
    } else {
      return wrappedVal;
    }
  }

  function showHowToPlay() {
    document.getElementById('hideable-menu-content').style.display = 'none';
    document.getElementById('game-rules').style.display = 'block';
  }
  function showMenuFromRules() {
    document.getElementById('hideable-menu-content').style.display = 'block';
    document.getElementById('game-rules').style.display = 'none';
  }
  function showDeveloperCommentary() {
    document.getElementById('hideable-menu-content').style.display = 'none';
    document.getElementById('developer-commentary').style.display = 'block';
  }
  function showMenuFromDeveloperCommentary() {
    document.getElementById('hideable-menu-content').style.display = 'block';
    document.getElementById('developer-commentary').style.display = 'none';
  }
  function showChoiceButtons() {
    document.getElementById('choice-button-holder').style.display = 'block';
  }
  function hideChoiceButtons() {
    document.getElementById('choice-button-holder').style.display = 'none';
  }
</script>
</head>
<body style="background-color:gray;">
<div id='menu-holder' class="menu-container">
  <div id='menu-presenter' class="menu-presenter">
    <div id='hideable-menu-content' style='display:block'>
      <h1>Circle Back</h1>
      <h3>A Trash Captains Production</h3>
      <p> For your consideration, an alchemy-themed mouse wheel game.</p>
      <button onclick="startGame()"> Play </button>
      <br>
      <br>
      <span><input id="useSound" type="checkbox" checked> Use Sound</span>
      <br>
      <span><input id="useMusic" type="checkbox" checked> Use Ambience</span>
      <br>
      <span><input id="useClick" type="checkbox" checked> Use Click and Right click for fine tuning (experimental)</span>
      <h3><a href="#" onclick="showHowToPlay()"> How to Play </a></h3>
      <h3><a href="#" onclick="showDeveloperCommentary()">Credits and Thanks</a></h3>
    </div>
    <div id='game-rules' style='display:none; margin:50px;'>
      <img style='position:absolute;left:-15%;top:-20%;display:flex;scale:50%' src="assets/tutorialDiagram1.png"/>
      <img style='position:absolute;left:20%;top:-20%;display:flex;scale:50%' src="assets/tutorialDiagram2.png"/>
      <img style='position:absolute;left:45%;top:-20%;display:flex;scale:50%' src="assets/tutorialDiagram3.png"/>
      <img style='position:absolute;top:30%;left:20%;display:flex;scale:50%' src="assets/tutorialDiagram4.png"/>
    <h3><a style='position:absolute;top:70%;left:65%;' href="#" onclick="showMenuFromRules()">Return to Menu</a></h3>
  </div>
    <div id='developer-commentary' style='display:none; margin:50px;'>
      <h2>Credits</h2>
      <ul>
        <li>Sounds - Creative Commons content from <a target='_blank' href="https://sonniss.com/gameaudiogdc">Sonniss</a></li>
        <li>Tools - vim and Pulsar Text Editors, <a target='_blank' href="https://svg-path-visualizer.netlify.app/">SVG Path Visualizer</a></li>
        <li>Javascript timer function original credit to <a target='_blank' href="https://stackoverflow.com/questions/20318822/how-to-create-a-stopwatch-using-javascript">this stackoverflow post.</a></li>
        <li>Mouse Icons for the tutorial images attribution: <a href="https://www.flaticon.com/free-icons/cursor" title="cursor icons">Cursor icons created by Pixel perfect - Flaticon</a></li>
        <li>Everything else - Emily (me)</li>
      </ul>
      <a href="#" onclick="showMenuFromDeveloperCommentary()">Return to Menu</a>

  </div>
  </div>
</div>



<div id='game-holder' class="container" style='display:none'>
<h2>Time Remaining: <span id='timerDisplay'></span></h2>
<div id='gamestate'></div>

<!-- Dialogs -->
  <dialog id="countdownDialog">Start in: <div id="countdownDisplay"></div></dialog>
  <dialog id="winDialog"><div id="scoreReport"></div>
    <br>
    <a href="#" onclick="returnToMenu()">Menu</a>
  </dialog>
  <dialog id="loseDialog"> You Lose... Better luck next time!
    <br>
    <a href="#" onclick="returnToMenu()">Menu</a>
  </dialog>
<!-- /Dialogs -->

<div id='ring_1' class="ring ring-one" curval=1 targetval=5 right=false ringnumber='1' >
  <img id="ring_1~graphic" class='guide_graphic' src="assets/initial.svg"/>
  <div id='ring_1~guide' class="ring-inner ring-inner-one" >
    <img id="ring_1~guide_graphic" src="assets/5g.svg"/>
    <div id='ring_2' class="ring ring-two" curval=1 targetval=5 right=false ringnumber='2' >
      <img id="ring_2~graphic" src="assets/initial.svg"/>
      <div id='ring_2~guide' class="ring-inner ring-inner-two" >
        <img id="ring_2~guide_graphic" src="assets/8g.svg"/>
        <div id='ring_3' class="ring ring-three" curval=1 targetval=5 right=false  ringnumber='3' >
          <img id="ring_3~graphic" src="assets/initial.svg"/>
          <div id='ring_3~guide' class="ring-inner ring-inner-three" >
            <img id="ring_3~guide_graphic" src="assets/8g.svg"/>
            <div id='ring_4' class="ring ring-four" curval=1 targetval=5 right=false ringnumber='4' >
              <img id="ring_4~graphic" src="assets/initial.svg"/>
              <div id='ring_4~guide' class="ring-inner ring-inner-four" >
                <img id="ring_4~guide_graphic" src="assets/8g.svg"/>
                <div id="choice-button-holder" class="choice-button-holder" style="display:none">
                  <button id="scoreButton" onclick="doWin()">Score</button>
                  <button id="deeperButton" onclick="goDeeper()">Go Deeper</button>
                  <button id="returnButton" onclick="goBack()">Return</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
<br/>
<audio id="clack">
  <source src="assets/sounds/smallClack.wav" type="audio/wav">
</audio>
<audio id="click">
  <source src="assets/sounds/smallClick.wav" type="audio/wav">
</audio>
<audio id="alpha1m">
  <source src="assets/sounds/110Hz_alpha_1m.wav" type="audio/wav">
</audio>
<audio id="beta1m">
  <source src="assets/sounds/75Hz_beta_1m.wav" type="audio/wav">
</audio>
<audio id="pressure10s">
  <source src="assets/sounds/pressureClock10s.wav" type="audio/wav">
</audio>
<audio id="ease">
  <source src="assets/sounds/Ease.wav" type="audio/wav">
</audio>
<audio id="latch">
  <source src="assets/sounds/Latch.wav" type="audio/wav">
</audio>


<script>
//-------- Borrowed from StackOverflow and modified.
var Timer = function(elem, options) {

  var timer = createTimer(),
    offset,
    clock,
    interval;

  // default options
  options = options || {};
  options.doTenSeconds = options.doTenSeconds || false;
  options.countdownFrom = options.countdownFrom || 60;
  options.delay = options.delay || 1;

  // append elements
  elem.appendChild(timer);

  // initialize
  reset();

  // private functions
  function createTimer() {
    return document.createElement("span");
  }


  function start() {
    if (!interval) {
      offset = Date.now();
      interval = setInterval(update, options.delay);
    }
  }

  function stop() {
    if (interval) {
      clearInterval(interval);
      interval = null;
    }
  }

  function reset() {
    clock = 0;
    render(0);
  }

  function update() {
    if(options.doTenSeconds) {
      checkTenSecondsRemain();
    }
    checkOutOfTime();
    clock += delta();
    render();
  }

  function checkTenSecondsRemain() {
    if((options.countdownFrom - (clock/1000)) <= 10) {
      options.tenSecondsCallback();
      options.doTenSeconds = false;
    }
  }
  function checkOutOfTime() {
    if((options.countdownFrom  - (clock / 1000)) <= 0) {
      stop();
      options.zeroCallback();
    }
  }

  function getRemaining() {
    return (options.countdownFrom - (clock / 1000)).toFixed(1);
  }

  function render() {
    timer.innerHTML = getRemaining();
  }

  function delta() {
    var now = Date.now(),
      d = now - offset;

    offset = now;
    return d;
  }

  // public API
  this.start = start;
  this.stop = stop;
  this.reset = reset;
  this.getRemaining = getRemaining;
};

//------- Thank you StackOverflow.

//-------- Audio Managers
//<audio id="clickIntoPlace">
//  <source src="assets/"
const clickSound = 'click';
const clackSound = 'clack';
const alphaMusic = 'alpha1m';
const betaMusic = 'beta1m';
const pressureMusic = 'pressure10s';
const easeSound = 'ease';
const latchSound = 'latch';
const allAudio = [
  clickSound,
  clackSound,
  alphaMusic,
  betaMusic,
  pressureMusic,
  easeSound,
  latchSound
];

function playSound(sound){
  if(gameState.useSound){
    document.getElementById(sound).volume = .5;
    document.getElementById(sound).play();
  }
}
function playMusic(music){
  if(gameState.useMusic){
    document.getElementById(music).volume = .5;
    document.getElementById(music).play();
  }
}
//Sound or music, since we don't have to break on settings.
function stopAudio(audio) {
  document.getElementById(audio).pause();
  document.getElementById(audio).currentTime = 0;
}

function stopAllAudioElements() {
  allAudio.forEach(stopAudio);
}
function playTenSecondsPressure() {
  if(gameState.useMusic){
    playMusic(pressureMusic);
  }
}

//-------- Quiet Now.

//--------- Game Manager Section. Sorry for the mess.

let timeLimit = 60;
let countIn = 5;
let gameTimer;
let countdown;

let solvedColor = '#867342';
let unsolvedColor = 'black';

let gameState = {
  circlesSolved: 0,
  levelsDeep: 0,
  hasWon: false,
  hasLost: false,
  isReturning: false,
  useSound: true,
  useMusic: true,
  useClickInsteadOfScroll: false,
  checkAllTimeoutId:"",
  circles: []
};

function doWin() {
  stopAllAudioElements();
  gameState.hasWon = true;
  hideChoiceButtons();
  gameTimer.stop();
  let timeRemaining = gameTimer.getRemaining();
  let timeUsed = timeLimit - timeRemaining;
  let timeUsedPercent = timeUsed/timeLimit;
  let totalScore = (timeUsedPercent * gameState.circlesSolved * 100).toFixed(2);
  document.getElementById("winDialog").showModal();
  // TODO: Compose detailed score report

  let scoreReport = "Score Report:\n";
  scoreReport = scoreReport + "Time Used: " + timeUsed.toFixed(2) + " seconds<br/>";
  scoreReport = scoreReport + "Time Remaining: " + timeRemaining + " seconds<br/>";
  scoreReport = scoreReport + "Percent of Time Used: " + (timeUsedPercent * 100).toFixed(2) + "%<br/>";
  scoreReport = scoreReport + "Number of Circles Solved: " + gameState.circlesSolved + "<br/>";
  scoreReport = scoreReport + "Total Score = (Percent Time Used * Number of Circles Solved) <br/>";
  scoreReport = scoreReport + "<strong> Total Score: " + totalScore + "</strong>";
  document.getElementById("scoreReport").innerHTML = scoreReport;
}

function lose() {
  stopAllAudioElements();
  if(gameState.hasWon) {
    return;
  } else {
    gameState.hasLost = true;
    hideChoiceButtons();
    gameTimer.stop();
    document.getElementById("loseDialog").showModal();
  }
}


let rate = 0.05;
let activeRings = 4;

//--------------- Controls -------------------
function slide(event) {
    //Track and reset IDLE Counter

    //rate = parseDouble(document.getElementById('rate').innerHTML);
    event.preventDefault();
    event.stopPropagation();
    let target = event.target;

    if(event.target.id.includes('~')) {
      target = document.getElementById(event.target.id.split('~')[0]);
    }
    if(!target.getAttribute("right").endsWith("true")){
      let newVal = makeBetweenTwoAndSixteen(parseInt(target.getAttribute('curval')) + event.deltaY * rate);
      target.setAttribute("curval", newVal);
      let ringNumber = target.getAttribute('ringnumber');
      let image = document.getElementById("ring_" + ringNumber + "~graphic");
      image.src ="assets/" + newVal + ".svg";
    }

    var currentTimeoutId = target.getAttribute('clampTimeoutId');
    if(currentTimeoutId) {
        clearTimeout(currentTimeoutId);
    }
    let timeoutId = setTimeout(function() {
        check(target);
        gameState.checkAllTimeoutId = '';
        checkAll();
    }, 250);
    gameState.checkAllTimeoutId = timeoutId;
}

//Add 1 to ring on left click.
function add(event) {
    //Track and reset IDLE Counter

    //rate = parseDouble(document.getElementById('rate').innerHTML);
    event.preventDefault();
    event.stopPropagation();
    let target = event.target;
    if(event.target.id.includes('~')) {
      target = document.getElementById(event.target.id.split('~')[0]);
    }
    if(!target.getAttribute("right").endsWith("true")){
      let newVal = makeBetweenTwoAndSixteen(parseInt(target.getAttribute('curval')) + 1);
      target.setAttribute("curval", newVal);
      let ringNumber = target.getAttribute('ringnumber');
      let image = document.getElementById("ring_" + ringNumber + "~graphic");
      image.src ="assets/" + newVal + ".svg";
    }

    var currentTimeoutId = target.getAttribute('clampTimeoutId');
    if(currentTimeoutId) {
        clearTimeout(currentTimeoutId);
    }
    let timeoutId = setTimeout(function() {
        check(target);
        gameState.checkAllTimeoutId = '';
        checkAll();
    }, 250);
    gameState.checkAllTimeoutId = timeoutId;
}
//Subtract 1 from ring on right click.
function subtract(event) {
    //Track and reset IDLE Counter

    //rate = parseDouble(document.getElementById('rate').innerHTML);
    event.preventDefault();
    event.stopPropagation();
    let target = event.target;
    if(event.target.id.includes('~')) {
      target = document.getElementById(event.target.id.split('~')[0]);
    }
    if(!target.getAttribute("right").endsWith("true")){
      let newVal = makeBetweenTwoAndSixteen(parseInt(target.getAttribute('curval')) - 1);
      target.setAttribute("curval", newVal);
      let ringNumber = target.getAttribute('ringnumber');
      let image = document.getElementById("ring_" + ringNumber + "~graphic");
      image.src ="assets/" + newVal + ".svg";
    }

    var currentTimeoutId = target.getAttribute('clampTimeoutId');
    if(currentTimeoutId) {
        clearTimeout(currentTimeoutId);
    }
    let timeoutId = setTimeout(function() {
        check(target);
        gameState.checkAllTimeoutId = '';
        checkAll();
    }, 250);
    gameState.checkAllTimeoutId = timeoutId;
    return false;
}
//------------- Out of Control, Sorry ---------------
const rings = ['ring_1','ring_2','ring_3','ring_4']

function attachClicks(id) {
  document.getElementById(id).addEventListener('click', add, false);
  document.getElementById(id).addEventListener('contextmenu', subtract, false);
}

function attachScroll(id) {
  document.getElementById(id).addEventListener('wheel', slide);
}

function startGame() {
  gameState.useSound = document.getElementById('useSound').checked;
  gameState.useMusic = document.getElementById('useMusic').checked;
  gameState.useClickInsteadOfScroll = document.getElementById('useClick').checked;
  document.getElementById('menu-holder').style.display = 'none';
  document.getElementById('game-holder').style.display = 'block';

  if(gameState.useClickInsteadOfScroll) {
    rings.forEach(attachClicks);
  }
  rings.forEach(attachScroll);

  beginCountdown();
  // Track idle time?
  // Show Depth Tracker?
  //
}

function returnToMenu() {
  location.reload();
}

function goDeeper() {
  gameState.levelsDeep += 1;
  hideChoiceButtons();
  beginCircle();
}
function goBack() {
  gameState.isReturning = true;
  stopAudio(alphaMusic);
  playMusic(betaMusic);
  hideChoiceButtons();
  beginCircle();
}

function beginCountdown() {
  document.getElementById("countdownDialog").showModal();
  countdown = new Timer(document.getElementById('countdownDisplay'),
    {"delay":100, "countdownFrom":countIn, "zeroCallback":beginGame});

  countdown.start();
}

function beginTimer() {
  countdown.stop();
  countdown.reset();
  gameTimer = new Timer(document.getElementById('timerDisplay'),
    {"delay": 100, "countdownFrom":timeLimit,
    "doTenSeconds":true, "tenSecondsCallback":playTenSecondsPressure, "zeroCallback":lose});

  gameTimer.start();
}

function beginGame(){
  document.getElementById("countdownDialog").close();
  playMusic(alphaMusic);
  beginTimer();
  beginCircle();
}

function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}
function getRandomRing() {
  return 2 + getRandomInt(15);
}
function reverseCircle(circle) {
  return {
    ring1goal: circle.ring4goal,
    ring2goal: circle.ring3goal,
    ring3goal: circle.ring2goal,
    ring4goal: circle.ring1goal
  }
}
function beginCircle() {

  let ring1 = document.getElementById("ring_1");
  let ring2 = document.getElementById("ring_2");
  let ring3 = document.getElementById("ring_3");
  let ring4 = document.getElementById("ring_4");

  ring1.style.backgroundColor = unsolvedColor;
  ring2.style.backgroundColor = unsolvedColor;
  ring3.style.backgroundColor = unsolvedColor;
  ring4.style.backgroundColor = unsolvedColor;

  ring1.setAttribute('right', false);
  ring2.setAttribute('right', false);
  ring3.setAttribute('right', false);
  ring4.setAttribute('right', false);

  let circle;
  if(gameState.isReturning) {
    playSound(latchSound);
    circle = reverseCircle(gameState.circles.pop());
  } else {
    circle = {
      ring1goal: getRandomRing(),
      ring2goal: getRandomRing(),
      ring3goal: getRandomRing(),
      ring4goal: getRandomRing()
    }
    gameState.circles.push(circle);
  }
  document.getElementById("ring_1").setAttribute("targetval",circle.ring1goal);
  document.getElementById("ring_1").style.pointerEvents = 'auto';
  document.getElementById("ring_1~guide_graphic").src = 'assets/'+circle.ring1goal + 'g.svg';
  document.getElementById("ring_2").setAttribute("targetval",circle.ring2goal);
  document.getElementById("ring_2").style.pointerEvents = 'auto';
  document.getElementById("ring_2~guide_graphic").src = 'assets/'+circle.ring2goal + 'g.svg';
  document.getElementById("ring_3").setAttribute("targetval",circle.ring3goal);
  document.getElementById("ring_3").style.pointerEvents = 'auto';
  document.getElementById("ring_3~guide_graphic").src = 'assets/'+circle.ring3goal + 'g.svg';
  document.getElementById("ring_4").setAttribute("targetval",circle.ring4goal);
  document.getElementById("ring_4").style.pointerEvents = 'auto';
  document.getElementById("ring_4~guide_graphic").src = 'assets/'+circle.ring4goal + 'g.svg';
}

function check(element) {
    let target = element.getAttribute('targetval');
    let curval = element.getAttribute('curval');
    if(curval === target) {
        element.style.color = solvedColor;
        element.style.backgroundColor = solvedColor;
        if(element.getAttribute('right').endsWith('false')) {
          element.setAttribute('right',true);
          //element.style.pointerEvents = 'none';
          playSound(clackSound);
        }
    } else {
        element.style.color = unsolvedColor;
        element.style.backgroundColor = unsolvedColor;
        element.setAttribute('right',false);
        playSound(clickSound);
    }

}

function checkAll() {
    let isRoundWin = true;
    for(var i = 1; i<=activeRings; i++) {
        isRoundWin = isRoundWin && ('true' === document.getElementById('ring_' + i).getAttribute('right'));
    }
    if(isRoundWin) {
      if(gameState.isReturning) {
        gameState.circlesSolved += 1;
        if(gameState.levelsDeep == 0){
          doWin();
        } else {
          gameState.levelsDeep -= 1;
          beginCircle();
        }
      } else {
        gameState.circlesSolved += 1;
        if(gameState.levelsDeep > 0){
          document.getElementById("scoreButton").hidden = true;
          document.getElementById("returnButton").hidden = false;
        } else {
          document.getElementById("scoreButton").hidden = false;
          document.getElementById("returnButton").hidden = true;
        }
        showChoiceButtons();
        playSound(easeSound);
      }
    }
}






</script>
</body>
</html>
